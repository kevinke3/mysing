{% extends "base.html" %}

{% block title %}Browse Cases - Loket{% endblock %}

{% block content %}
<section class="browse-section">
    <div class="container">
        <div class="browse-header">
            <h1>Browse Missing Persons Cases</h1>
            <p>Search through our database of missing persons cases</p>
        </div>
        
        <div class="search-filters">
            <form method="GET" class="search-form">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" name="q" id="searchInput" placeholder="Search by name or description..." value="{{ search_query }}">
                        <button type="submit" id="searchBtn"><i class="fas fa-search"></i></button>
                    </div>
                    <select name="region" id="regionFilter">
                        <option value="">All Regions</option>
                        {% for region in regions %}
                            <option value="{{ region }}" {% if region == selected_region %}selected{% endif %}>{{ region }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
        
        <div class="search-results">
            {% if missing_persons %}
            <div class="cases-grid">
                {% for person in missing_persons %}
                <div class="case-card">
                    <div class="case-image">
                        <img src="{{ person.photo_url }}" alt="{{ person.name }}">
                    </div>
                    <div class="case-info">
                        <h3>{{ person.name }}</h3>
                        <p><strong>Age:</strong> {{ person.age }}</p>
                        <p><strong>Last Seen:</strong> {{ person.last_seen }}</p>
                        <p><strong>Date:</strong> {{ person.last_seen_date.strftime('%Y-%m-%d') }}</p>
                        <p><strong>Contact:</strong> {{ person.contact_name }}</p>
                        
                        <div class="case-actions">
                            <a href="{{ url_for('case_details', person_id=person.id) }}" class="btn-case-details">
                                <i class="fas fa-info-circle"></i> View Details
                            </a>
                            {% if current_user.is_authenticated %}
                            <a href="tel:{{ person.contact_phone|replace('(', '')|replace(')', '')|replace(' ', '')|replace('-', '') }}" 
                               class="btn-report-sighting">
                                <i class="fas fa-phone"></i> Call Reporter
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>No Cases Found</h3>
                <p>No missing persons cases match your search criteria.</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Simple Call Confirmation Modal -->
<div id="callModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="call-confirmation">
            <div class="call-icon">
                <i class="fas fa-phone"></i>
            </div>
            <h3>Ready to Call</h3>
            <p>You are about to call the contact person for this missing person case.</p>
            <div class="call-details">
                <p><strong>Contact:</strong> <span id="callContactName"></span></p>
                <p><strong>Phone:</strong> <span id="callPhoneNumber"></span></p>
                <p><strong>Regarding:</strong> <span id="callPersonName"></span></p>
            </div>
            <div class="call-actions">
                <a href="#" id="confirmCallBtn" class="btn btn-primary btn-call">
                    <i class="fas fa-phone"></i> Call Now
                </a>
                <button class="btn btn-outline" id="cancelCallBtn">Cancel</button>
            </div>
            <div class="call-guidance">
                <h4>What to say when you call:</h4>
                <ul>
                    <li>Identify yourself and mention you're calling from Loket</li>
                    <li>Describe where and when you saw the person</li>
                    <li>Provide any important details about their appearance or situation</li>
                    <li>Be prepared to share your contact information if needed</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const callModal = document.getElementById('callModal');
    const confirmCallBtn = document.getElementById('confirmCallBtn');
    const cancelCallBtn = document.getElementById('cancelCallBtn');
    const closeModal = document.querySelector('.close-modal');
    
    // Add click event to all call buttons
    document.querySelectorAll('.btn-report-sighting').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const caseCard = this.closest('.case-card');
            const personName = caseCard.querySelector('h3').textContent;
            const contactName = caseCard.querySelector('p:nth-child(5)').textContent.replace('Contact: ', '');
            const phoneLink = this.getAttribute('href');
            const phoneNumber = phoneLink.replace('tel:', '');
            
            // Format phone number for display
            const formattedPhone = formatPhoneNumber(phoneNumber);
            
            // Update modal content
            document.getElementById('callContactName').textContent = contactName;
            document.getElementById('callPhoneNumber').textContent = formattedPhone;
            document.getElementById('callPersonName').textContent = personName;
            
            // Update call link
            confirmCallBtn.href = phoneLink;
            
            // Show modal
            callModal.style.display = 'block';
        });
    });
    
    // Close modal events
    closeModal.addEventListener('click', function() {
        callModal.style.display = 'none';
    });
    
    cancelCallBtn.addEventListener('click', function() {
        callModal.style.display = 'none';
    });
    
    window.addEventListener('click', function(e) {
        if (e.target === callModal) {
            callModal.style.display = 'none';
        }
    });
    
    // Phone number formatting function
    function formatPhoneNumber(phoneNumber) {
        // Remove all non-numeric characters
        const cleaned = phoneNumber.replace(/\D/g, '');
        
        // Check if the number looks like a Kenyan number
        if (cleaned.length === 10 && cleaned.startsWith('0')) {
            return `+254 ${cleaned.substring(1, 4)} ${cleaned.substring(4, 7)} ${cleaned.substring(7)}`;
        } else if (cleaned.length === 12 && cleaned.startsWith('254')) {
            return `+${cleaned.substring(0, 3)} ${cleaned.substring(3, 6)} ${cleaned.substring(6, 9)} ${cleaned.substring(9)}`;
        } else if (cleaned.length === 9) {
            return `+254 ${cleaned.substring(0, 3)} ${cleaned.substring(3, 6)} ${cleaned.substring(6)}`;
        }
        
        // Default formatting for other numbers
        return phoneNumber;
    }
});
</script>
{% endblock %}